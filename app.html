<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alteryx Data Lineage Visualizer (Collaborative)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease-in-out; }
        .drop-zone.drag-over { background-color: #e2e8f0; border-color: #94a3b8; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .graph-container { width: 100%; height: 600px; border: 1px solid #e2e8f0; border-radius: 0.75rem; background-color: #f8fafc; }
        .node-workflow { stroke: #2563eb; stroke-width: 2px; fill: #60a5fa; cursor: pointer; }
        .node-datasource { stroke: #475569; stroke-width: 2px; fill: #cbd5e1; cursor: pointer; }
        .node-api { stroke: #7c3aed; stroke-width: 2px; fill: #a78bfa; cursor: pointer; }
        .link { stroke: #94a3b8; stroke-opacity: 0.8; }
        .node-label { font-size: 10px; pointer-events: none; }
        .tooltip { position: absolute; text-align: center; padding: 8px; font: 12px sans-serif; background: #1f2937; color: white; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.2s; }

        @media print {
            body * { visibility: hidden; }
            #graph-container, #graph-container * { visibility: visible; }
            #graph-container { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border: none; }
            .graph-container svg { background-color: white !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Alteryx Data Lineage Visualizer</h1>
            <p class="mt-2 text-lg text-slate-600">A real-time, collaborative map of your team's Alteryx workflows.</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="upload-container" class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                <div id="drop-zone" class="drop-zone w-full rounded-lg p-10 text-center cursor-pointer">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-16 h-16 text-slate-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <p class="text-slate-700 font-semibold">Drag & drop your .yxmd files here</p>
                        <p class="text-slate-500 text-sm mt-1">or click to select files</p>
                    </div>
                    <input type="file" id="file-input" multiple accept=".yxmd" class="hidden">
                </div>
                <div id="loader" class="hidden flex-col items-center justify-center mt-6">
                    <div class="loader"></div>
                    <p class="mt-4 text-slate-600">Parsing and updating lineage...</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="mt-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <div>
                        <button id="view-toggle-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Switch to Report View</button>
                        <button id="print-graph-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Print Graph</button>
                    </div>
                </div>
                
                <div id="graph-view">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-900">Graph View</h2>
                        <div class="relative">
                            <div class="flex items-center gap-2">
                               <input type="search" id="graph-search-input" placeholder="Find a node..." class="w-full max-w-xs bg-white rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out" autocomplete="off">
                               <button id="graph-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Go</button>
                            </div>
                            <div id="graph-search-results" class="hidden absolute z-10 w-full bg-white rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div id="graph-container" class="graph-container relative"></div>
                    <div id="tooltip" class="tooltip"></div>
                </div>

                <div id="report-view" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-900">Report View</h2>
                        <input type="text" id="report-search-input" placeholder="Search workflows..." class="w-full max-w-xs bg-white rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
                    </div>
                    <div id="results" class="space-y-6"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Node Inspector Modal -->
    <div id="connections-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-2">
                 <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Node Inspector</h3>
                 <button id="close-connections-modal" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4" id="modal-content"></div>
            <div id="alias-editor" class="hidden mt-4 pt-4 border-t">
                 <p class="text-sm text-gray-500 mb-1 text-left font-semibold">Original Name:</p>
                 <p id="original-name" class="text-xs text-gray-500 bg-gray-100 p-2 rounded break-all text-left"></p>
                 <p class="text-sm text-gray-500 mt-4 mb-1 text-left font-semibold">Alias:</p>
                 <input type="text" id="alias-input" class="w-full bg-white rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out" placeholder="e.g., Centric Source">
                 <div class="flex gap-2 mt-4">
                    <button id="save-alias-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Save</button>
                    <button id="cancel-alias-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancel</button>
                 </div>
            </div>
        </div>
    </div>


    <script>
        // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        const firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
            // storageBucket: "...",
            // messagingSenderId: "...",
            // appId: "..."
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, getDocs, query, where, writeBatch, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- UI Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const viewToggleBtn = document.getElementById('view-toggle-btn');
        const printGraphBtn = document.getElementById('print-graph-btn');
        const reportView = document.getElementById('report-view');
        const graphView = document.getElementById('graph-view');
        const tooltipEl = document.getElementById('tooltip');
        const resultsDiv = document.getElementById('results');
        const reportSearchInput = document.getElementById('report-search-input');
        const graphSearchInput = document.getElementById('graph-search-input');
        const graphSearchBtn = document.getElementById('graph-search-btn');
        const graphSearchResults = document.getElementById('graph-search-results');
        const connectionsModal = document.getElementById('connections-modal');
        const connectionsModalContent = document.getElementById('modal-content');
        const connectionsModalTitle = document.getElementById('modal-title');
        const closeConnectionsModalBtn = document.getElementById('close-connections-modal');
        const aliasEditor = document.getElementById('alias-editor');
        const originalNameEl = document.getElementById('original-name');
        const aliasInput = document.getElementById('alias-input');
        const saveAliasBtn = document.getElementById('save-alias-btn');
        const cancelAliasBtn = document.getElementById('cancel-alias-btn');

        // --- Firebase & App State ---
        let db;
        let auth;
        let workflowsCol, datasourcesCol, connectionsCol;
        let currentEditingDsId = null;
        let allData = { workflows: [], datasources: [], connections: [] };
        let d3Graph = {}; 
        
        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        viewToggleBtn.addEventListener('click', () => {
            reportView.classList.toggle('hidden');
            graphView.classList.toggle('hidden');
            printGraphBtn.classList.toggle('hidden');
            viewToggleBtn.textContent = reportView.classList.contains('hidden') ? 'Switch to Report View' : 'Switch to Graph View';
        });
        printGraphBtn.addEventListener('click', () => window.print());
        closeConnectionsModalBtn.addEventListener('click', () => connectionsModal.classList.add('hidden'));
        cancelAliasBtn.addEventListener('click', () => aliasEditor.classList.add('hidden'));
        saveAliasBtn.addEventListener('click', async () => {
            if (currentEditingDsId) {
                await updateDatasourceAlias(currentEditingDsId, aliasInput.value);
                aliasEditor.classList.add('hidden');
                currentEditingDsId = null;
            }
        });
        reportSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            displayReport(allData.workflows, allData.datasources, allData.connections, searchTerm);
        });
        graphSearchInput.addEventListener('input', () => {
            const searchTerm = graphSearchInput.value.toLowerCase();
            graphSearchResults.innerHTML = '';
            if (!searchTerm) {
                graphSearchResults.classList.add('hidden');
                return;
            }
            const allNodes = [ ...allData.workflows.map(d => ({ displayName: d.name })), ...allData.datasources.map(d => ({ displayName: d.alias || d.name })) ];
            const filteredNodes = allNodes.filter(node => node.displayName.toLowerCase().includes(searchTerm));
            if (filteredNodes.length > 0) {
                filteredNodes.slice(0, 10).forEach(node => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm truncate';
                    item.textContent = node.displayName;
                    item.onclick = () => {
                        graphSearchInput.value = node.displayName;
                        graphSearchResults.classList.add('hidden');
                    };
                    graphSearchResults.appendChild(item);
                });
                graphSearchResults.classList.remove('hidden');
            } else {
                graphSearchResults.classList.add('hidden');
            }
        });
        document.addEventListener('click', (e) => {
            if (!graphSearchInput.contains(e.target)) {
                graphSearchResults.classList.add('hidden');
            }
        });
        graphSearchBtn.addEventListener('click', () => {
            panToNode(graphSearchInput.value);
        });


        // --- Core Functions ---
        async function handleFiles(files) {
            loader.classList.remove('hidden');
            for (const file of files) {
                if (file.name.endsWith('.yxmd')) {
                    try {
                        const fileContent = await readFileAsText(file);
                        const workflowData = parseWorkflow(fileContent, file.name);
                        await saveDataToDB(workflowData);
                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                    }
                }
            }
            loader.classList.add('hidden');
            fileInput.value = '';
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseWorkflow(xmlString, fileName) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            const nodes = xmlDoc.getElementsByTagName('Node');
            const results = { name: fileName, inputs: [], outputs: [] };
            
            for (const node of nodes) {
                let path, type, value;
                
                const annotationNode = node.querySelector('Annotation');
                const annotationText = annotationNode?.querySelector('AnnotationText')?.textContent || annotationNode?.querySelector('DefaultAnnotationText')?.textContent || '';
                const lineageMatch = annotationText.match(/--- lineage ---([\s\S]*?)---/);

                if (lineageMatch) {
                    const content = lineageMatch[1];
                    let currentSection = null;
                    const lines = content.split('\n');

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('inputs:')) { currentSection = 'inputs'; continue; }
                        if (line.startsWith('outputs:')) { currentSection = 'outputs'; continue; }
                        if (line.startsWith('- type:')) {
                            const typeMatch = line.match(/- type:\s*(\w+)/);
                            if (typeMatch && i + 1 < lines.length) {
                                const nextLine = lines[i + 1].trim();
                                const pathMatch = nextLine.match(/path:\s*(.*)/);
                                if (pathMatch) {
                                    const targetArray = currentSection === 'inputs' ? results.inputs : results.outputs;
                                    if (targetArray) {
                                        targetArray.push({
                                            type: typeMatch[1],
                                            value: { connection: pathMatch[1], query: '' }
                                        });
                                    }
                                    i++; 
                                }
                            }
                        }
                    }
                    continue; 
                }

                const plugin = node.querySelector('GuiSettings')?.getAttribute('Plugin');
                if (!plugin) continue;

                if (plugin.includes('Input') || plugin.includes('Output')) {
                    const fileElement = node.querySelector('Properties > Configuration > File');
                    if (fileElement) {
                        path = fileElement.textContent;
                        const isDb = path.startsWith('odbc:') || path.startsWith('aka:');
                        type = isDb ? 'Database' : 'File';
                        value = isDb && path.includes('|||') ? { connection: path.split('|||')[0], query: path.split('|||')[1] || '' } : { connection: path, query: '' };
                        const targetArray = plugin.includes('Input') ? results.inputs : results.outputs;
                        targetArray.push({ type, value });
                    }
                }
                
                if (plugin.includes('DynamicInput')) {
                    const templateFileElement = node.querySelector('Properties > Configuration > InputConfiguration > Configuration > File');
                     if (templateFileElement) {
                        path = templateFileElement.textContent;
                        type = 'File';
                        value = { connection: `(Dynamic) ${path}`, query: '' };
                        results.inputs.push({ type, value });
                    }
                }
                
                const engineSettings = node.querySelector('EngineSettings');
                if (engineSettings && engineSettings.getAttribute('Macro')?.includes('Input Data Selector.yxmc')) {
                     const valueElement = node.querySelector('Properties > Configuration > Value');
                     if(valueElement) {
                        path = valueElement.textContent;
                        type = 'File';
                        value = { connection: path, query: '' };
                        results.inputs.push({ type, value });
                     }
                }
            }
            return results;
        }
        
        // --- Firestore Data Operations ---
        async function saveDataToDB(workflowData) {
            const q = query(workflowsCol, where("name", "==", workflowData.name));
            const querySnapshot = await getDocs(q);
            
            let workflowId;

            if (!querySnapshot.empty) {
                const workflowDoc = querySnapshot.docs[0];
                workflowId = workflowDoc.id;
                console.log(`Updating existing workflow: ${workflowData.name}`);
                const oldConnectionsQuery = query(connectionsCol, where("workflowId", "==", workflowId));
                const oldConnectionsSnapshot = await getDocs(oldConnectionsQuery);
                const batch = writeBatch(db);
                oldConnectionsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                console.log(`Removed ${oldConnectionsSnapshot.size} old connections.`);
            } else {
                console.log(`Creating new workflow: ${workflowData.name}`);
                const workflowDocRef = await addDoc(workflowsCol, { name: workflowData.name });
                workflowId = workflowDocRef.id;
            }

            const processConnections = async (items, direction) => {
                for (const item of items) {
                    const dsQuery = query(datasourcesCol, where("name", "==", item.value.connection));
                    const dsSnapshot = await getDocs(dsQuery);
                    let dsId;
                    if (dsSnapshot.empty) {
                        const newDsDocRef = await addDoc(datasourcesCol, { name: item.value.connection, type: item.type, alias: '' });
                        dsId = newDsDocRef.id;
                    } else {
                        dsId = dsSnapshot.docs[0].id;
                    }
                    await addDoc(connectionsCol, { workflowId: workflowId, dsId, direction, query: item.value.query });
                }
            };
            await processConnections(workflowData.inputs, 'input');
            await processConnections(workflowData.outputs, 'output');
        }

        async function updateDatasourceAlias(dsId, newAlias) {
            const dsDocRef = doc(db, `/artifacts/alteryx-lineage-viewer/public/data/datasources/${dsId}`);
            await updateDoc(dsDocRef, { alias: newAlias });
        }
        
        // --- Real-time Listener ---
        function setupRealtimeListener() {
            const render = () => {
                const searchTerm = reportSearchInput.value.toLowerCase();
                displayReport(allData.workflows, allData.datasources, allData.connections, searchTerm);
                renderGraph(allData.workflows, allData.datasources, allData.connections);
            };
            onSnapshot(workflowsCol, (snapshot) => {
                allData.workflows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(datasourcesCol, (snapshot) => {
                allData.datasources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(connectionsCol, (snapshot) => {
                allData.connections = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        // --- UI & Rendering Functions ---
        function displayReport(workflows, datasources, connections, searchTerm = '') {
            resultsDiv.innerHTML = '';
            if (!workflows || workflows.length === 0) {
                resultsDiv.innerHTML = '<p class="text-slate-500">No workflows analyzed yet.</p>';
                return;
            }
            let queryCounter = 0;
            const dsMap = new Map(Array.isArray(datasources) ? datasources.map(ds => [ds.id, ds]) : []);

            const filteredWorkflows = workflows.filter(workflow => {
                if (!searchTerm) return true;
                if (workflow.name.toLowerCase().includes(searchTerm)) return true;

                const workflowConnections = connections.filter(c => c.workflowId === workflow.id);
                for (const conn of workflowConnections) {
                    const ds = dsMap.get(conn.dsId);
                    if (ds) {
                        if (ds.name.toLowerCase().includes(searchTerm)) return true;
                        if (ds.alias && ds.alias.toLowerCase().includes(searchTerm)) return true;
                    }
                    if (conn.query && conn.query.toLowerCase().includes(searchTerm)) return true;
                }
                return false;
            });

            if (filteredWorkflows.length === 0) {
                resultsDiv.innerHTML = '<p class="text-slate-500">No workflows match your search.</p>';
                return;
            }

            filteredWorkflows.forEach(workflow => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md';
                let content = `<h3 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4">${workflow.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
                const workflowConnections = connections.filter(c => c.workflowId === workflow.id);
                const inputs = workflowConnections.filter(c => c.direction === 'input');
                const outputs = workflowConnections.filter(c => c.direction === 'output');
                const renderList = (items, color) => {
                    if (items.length === 0) return `<p class="text-slate-500 italic text-sm">No ${color === 'green' ? 'inputs' : 'outputs'} found.</p>`;
                    return `<ul class="space-y-2">${items.map(conn => {
                        const ds = dsMap.get(conn.dsId);
                        if (!ds) return '';
                        const item = { type: ds.type, value: { connection: ds.name, query: conn.query }, alias: ds.alias, id: ds.id };
                        return renderListItem(item, color, queryCounter++);
                    }).join('')}</ul>`;
                };
                content += `<div><h4 class="text-lg font-semibold text-green-700 mb-3">Inputs</h4>${renderList(inputs, 'green')}</div>`;
                content += `<div><h4 class="text-lg font-semibold text-red-700 mb-3">Outputs</h4>${renderList(outputs, 'red')}</div>`;
                content += '</div>';
                card.innerHTML = content;
                resultsDiv.appendChild(card);
            });
        }

        function renderListItem(item, color, id) {
            const bgColor = color === 'green' ? 'bg-green-50' : 'bg-red-50';
            const uniqueId = `query-${id}`;
            const arrowId = `arrow-${id}`;
            let content = `<div class="flex justify-between items-start">
                             <div class="break-all">${renderPill(item.type)} <b>${item.alias || item.value.connection}</b>
                                ${item.alias ? `<span class="text-xs text-gray-500">(${item.value.connection})</span>` : ''}
                             </div>
                             <button onclick="window.showConnectionsModal({ id: 'ds-${item.id}', name: '${item.value.connection}', alias: '${item.alias || ''}', type: '${item.type}' })" class="ml-2 p-1 rounded-full hover:bg-gray-200 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                             </button>
                           </div>`;
            if ((item.type === 'Database' || item.type === 'API') && item.value.query) {
                content += `<div class="mt-2">
                    <button onclick="toggleQuery('${uniqueId}', '${arrowId}')" class="flex items-center text-xs font-semibold text-slate-600 hover:text-slate-800 focus:outline-none">
                        <svg id="${arrowId}" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        Show Details
                    </button>
                    <div id="${uniqueId}" class="hidden mt-1 pl-4 border-l-2 border-slate-200">
                        <pre class="bg-slate-100 p-2 rounded-md text-xs text-slate-800">${item.value.query.trim()}</pre>
                    </div>
                </div>`;
            }
            return `<li class="p-3 ${bgColor} rounded-lg text-sm">${content}</li>`;
        }
        
        function renderPill(type) {
            const colors = { 
                'File': 'bg-sky-200 text-sky-800', 
                'Database': 'bg-amber-200 text-amber-800',
                'API': 'bg-purple-200 text-purple-800'
            };
            return `<span class="font-mono text-xs font-bold px-2 py-1 rounded mr-2 align-top ${colors[type] || 'bg-slate-200'}">${type}</span>`;
        }

        window.toggleQuery = (elementId, arrowId) => {
            document.getElementById(elementId)?.classList.toggle('hidden');
            document.getElementById(arrowId)?.classList.toggle('rotate-90');
        };

        function renderGraph(workflows, datasources, connections) {
            const graphContainer = d3.select("#graph-container");
            graphContainer.selectAll("*").remove();
            if (!workflows || workflows.length === 0 && (!datasources || datasources.length === 0)) {
                graphContainer.append("div").attr("class", "flex items-center justify-center h-full text-slate-500").text("No data. Drop workflow files to start.");
                return;
            }
            const width = graphContainer.node().getBoundingClientRect().width;
            const height = 600;
            const zoom = d3.zoom().on("zoom", e => g.attr("transform", e.transform));
            const svg = graphContainer.append("svg").attr("width", width).attr("height", height).call(zoom);
            const g = svg.append("g");
            const tooltip = d3.select(tooltipEl);
            const wfNodes = workflows.map(d => ({ id: `wf-${d.id}`, name: d.name, type: 'workflow' }));
            const dsNodes = datasources.map(d => ({ id: `ds-${d.id}`, name: d.name, type: d.type, alias: d.alias }));
            const nodes = [...wfNodes, ...dsNodes];
            
            d3Graph.nodes = nodes;
            d3Graph.svg = svg;
            d3Graph.zoom = zoom;
            d3Graph.width = width;
            d3Graph.height = height;

            const links = connections.map(d => ({ source: d.direction === 'input' ? `ds-${d.dsId}` : `wf-${d.workflowId}`, target: d.direction === 'input' ? `wf-${d.workflowId}` : `ds-${d.dsId}` }));
            const simulation = d3.forceSimulation(nodes).force("link", d3.forceLink(links).id(d => d.id).distance(100)).force("charge", d3.forceManyBody().strength(-300)).force("center", d3.forceCenter(width / 2, height / 2));
            svg.append("defs").append("marker").attr("id", "arrowhead").attr("viewBox", "-0 -5 10 10").attr("refX", 25).attr("refY", 0).attr("orient", "auto").attr("markerWidth", 8).attr("markerHeight", 8).append("svg:path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#94a3b8");
            const link = g.append("g").selectAll("line").data(links).join("line").attr("class", "link").attr("stroke-width", 2).attr("marker-end", "url(#arrowhead)");
            const node = g.append("g").selectAll("g").data(nodes).join("g").call(drag(simulation));
            node.append("circle").filter(d => d.type === 'workflow').attr("r", 15).attr("class", "node-workflow");
            node.append("rect").filter(d => d.type === 'File' || d.type === 'Database').attr("width", 30).attr("height", 20).attr("x", -15).attr("y", -10).attr("rx", 3).attr("ry", 3).attr("class", "node-datasource");
            node.append("path").filter(d => d.type === 'API').attr('d', 'M-15,-10 h30 v20 h-30 z M-15,0 h30 M-10,-10 v20 M10,-10 v20').attr('class', 'node-api');
            node.append("text").attr("class", "node-label").attr("dy", d => d.type === 'workflow' ? 25 : 22).attr("text-anchor", "middle").text(d => {
                const displayName = d.alias || d.name;
                return displayName.length > 20 ? displayName.substring(0, 18) + '...' : displayName;
            });
            node.on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(d.name).style("left", (event.pageX + 5) + "px").style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });
            node.on('click', (event, d) => {
                showConnectionsModal(d);
            });
            simulation.on("tick", () => { link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y); node.attr("transform", d => `translate(${d.x},${d.y})`); });
            function drag(simulation) {
                function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
                function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
                function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            }
        }

        function panToNode(nodeName) {
            const targetNode = d3Graph.nodes.find(n => (n.alias || n.name) === nodeName);
            if (targetNode) {
                const scale = 1.5;
                const x = d3Graph.width / 2 - targetNode.x * scale;
                const y = d3Graph.height / 2 - targetNode.y * scale;
                d3Graph.svg.transition().duration(750).call(
                    d3Graph.zoom.transform,
                    d3.zoomIdentity.translate(x, y).scale(scale)
                );
                d3.selectAll("circle, rect, path").filter(d => d.id === targetNode.id)
                    .transition().duration(250).attr('stroke', '#ef4444').attr('stroke-width', 4)
                    .transition().duration(750).delay(500)
                    .attr('stroke-width', 2)
                    .attr('stroke', d => {
                        if (d.type === 'workflow') return '#2563eb';
                        if (d.type === 'API') return '#7c3aed';
                        return '#475569';
                    });
            }
        }

        function showConnectionsModal(nodeData) {
            const nodeId = nodeData.id.split('-')[1];
            const isWorkflow = nodeData.type === 'workflow';
            
            const inputs = allData.connections.filter(c => (isWorkflow ? c.workflowId : c.dsId) === nodeId && c.direction === 'input');
            const outputs = allData.connections.filter(c => (isWorkflow ? c.workflowId : c.dsId) === nodeId && c.direction === 'output');

            const dsMap = new Map(allData.datasources.map(ds => [ds.id, ds]));
            const wfMap = new Map(allData.workflows.map(wf => [wf.id, wf]));

            const createLinkList = (connections) => {
                if (connections.length === 0) return '<p class="text-sm text-gray-500">None</p>';
                return `<ul class="list-disc pl-5 space-y-1">${connections.map(c => {
                    const otherNodeId = isWorkflow ? c.dsId : c.workflowId;
                    const otherNode = isWorkflow ? dsMap.get(otherNodeId) : wfMap.get(otherNodeId);
                    if (!otherNode) return '';
                    const displayName = otherNode.alias || otherNode.name;
                    return `<li class="break-all"><a href="#" onclick="window.panToNodeAndClose('${displayName.replace(/'/g, "\\'")}')" class="text-blue-600 hover:underline">${displayName}</a></li>`;
                }).join('')}</ul>`;
            };

            connectionsModalTitle.innerHTML = `<span class="font-normal">Inspector:</span> <b class="break-all">${nodeData.alias || nodeData.name}</b>`;
            let content = `<div class="grid grid-cols-2 gap-4 mt-4">
                <div><h4 class="font-semibold text-gray-800 border-b pb-1 mb-2">Inputs</h4>${createLinkList(isWorkflow ? inputs : outputs)}</div>
                <div><h4 class="font-semibold text-gray-800 border-b pb-1 mb-2">Outputs</h4>${createLinkList(isWorkflow ? outputs : inputs)}</div>
            </div>`;
            
            connectionsModalContent.innerHTML = content;
            
            if (!isWorkflow) {
                aliasEditor.classList.remove('hidden');
                currentEditingDsId = nodeId;
                originalNameEl.textContent = nodeData.name;
                aliasInput.value = nodeData.alias || '';
            } else {
                aliasEditor.classList.add('hidden');
            }
            
            connectionsModal.classList.remove('hidden');
        }

        window.panToNodeAndClose = (nodeName) => {
            connectionsModal.classList.add('hidden');
            panToNode(nodeName);
        }

        // --- Initial Load ---
        async function main() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase config not found or incomplete.");
                document.body.innerHTML = '<div class="text-red-500 p-8 text-center"><b>Error: Firebase Configuration Missing.</b><br>Please follow the setup guide to paste your Firebase project configuration into the HTML file.</div>';
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const appId = 'alteryx-lineage-viewer';
            workflowsCol = collection(db, `/artifacts/${appId}/public/data/workflows`);
            datasourcesCol = collection(db, `/artifacts/${appId}/public/data/datasources`);
            connectionsCol = collection(db, `/artifacts/${appId}/public/data/connections`);
            try {
                await signInAnonymously(auth);
                console.log("Firebase authentication successful.");
                setupRealtimeListener();
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                document.body.innerHTML = '<div class="text-red-500 p-8">Error: Could not authenticate with the database.</div>';
            }
        }

        main();

    </script>
</body>
</html>
